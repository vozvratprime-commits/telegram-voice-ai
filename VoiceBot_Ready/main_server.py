import os
from flask import Flask, request, jsonify, send_file
from google import genai
import requests
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY', 'AIzaSyC9sOYolnT2pX-ZTRlc511Rlwnjx1yG1OQ')
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '8512856028:AAEzmZQtARQCxGm3v2FyRAOPpJ2-v2GxmeQ')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID', '5173175651')

try:
    client = genai.Client(api_key=GEMINI_API_KEY)
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ Gemini: {e}")


def send_telegram(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": TELEGRAM_CHAT_ID,
        "text": text,
        "parse_mode": "Markdown"
    }
    try:
        requests.post(url, json=payload, timeout=5)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")


@app.route('/')
def index():
    return send_file('index.html')


@app.route('/ask_ai', methods=['POST'])
def ask_ai():
    data = request.json
    question = data.get('question', '')
    context = data.get('context', '')

    if not question:
        return jsonify({"status": "error", "message": "–í–æ–ø—Ä–æ—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."}), 400

    print(f"\n{'=' * 60}")
    print(f"–í–û–ü–†–û–°: {question}")
    print(f"–ö–û–ù–¢–ï–ö–°–¢:\n{context if context else '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")
    print(f"{'=' * 60}\n")

    # –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø –ö–û–ù–¢–ï–ö–°–¢–ê
    prompt = f"""
–¢—ã - —É–º–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–∞–º—è—Ç—å—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π Google Search –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤.

üìã –ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê (–ö–û–ù–¢–ï–ö–°–¢):
{context if context else "–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"}

‚ùì –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°:
{question}

üéØ –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ—á–∏—Ç–∞–π –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
2. –û–ø—Ä–µ–¥–µ–ª–∏, –æ —á—ë–º –∏–¥—ë—Ç —Ä–µ—á—å (—Ç–µ–º–∞, –æ–±—ä–µ–∫—Ç, –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏ —Ç.–¥.)
3. –ï—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –µ—Å—Ç—å –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è (—ç—Ç–æ, —ç—Ç–æ—Ç, –æ–Ω, –æ–Ω–∞, —Ç–æ—Ç, —Ç–∞, —Ç–∞–∫–æ–π), –∑–∞–º–µ–Ω–∏ –∏—Ö –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. –ü—Ä–æ–≤–µ–¥–∏ –ø–æ–∏—Å–∫ –≤ Google —Å —É—á—ë—Ç–æ–º –ü–û–õ–ù–û–ì–û –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
5. –û—Ç–≤–µ—Ç—å –ö–†–ê–¢–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏, –º–∞–∫—Å–∏–º—É–º 5 —Å–ª–æ–≤

üìñ –ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –†–ê–ë–û–¢–´:

–ü–†–ò–ú–ï–† 1:
–ö–æ–Ω—Ç–µ–∫—Å—Ç: 
[1] –∏–∑ —Ä–æ–º–∞–Ω–∞ –º–∞—Å—Ç–µ—Ä –∏ –º–∞—Ä–≥–∞—Ä–∏—Ç–∞
[2] –≥–æ–≤–æ—Ä–∏–º –ø—Ä–æ –∫—Ä–µ–º –∫–æ—Ç–æ—Ä—ã–º –º–∞–∑–∞–ª–∞—Å—å –º–∞—Ä–≥–∞—Ä–∏—Ç–∞
–í–æ–ø—Ä–æ—Å: "–∞ —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –¥–µ–ª–∞–ª —ç—Ç–æ—Ç –∫—Ä–µ–º"
‚Üí –ü–æ–Ω–∏–º–∞–µ—à—å: "—ç—Ç–æ—Ç –∫—Ä–µ–º" = –∫—Ä–µ–º –ú–∞—Ä–≥–∞—Ä–∏—Ç—ã –∏–∑ —Ä–æ–º–∞–Ω–∞ "–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞"
‚Üí –ò—â–µ—à—å: "–∫—Ä–µ–º –ú–∞—Ä–≥–∞—Ä–∏—Ç—ã –ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç —á—Ç–æ –¥–µ–ª–∞–ª"
‚Üí –û—Ç–≤–µ—Ç: "–¥–µ–ª–∞–ª –Ω–µ–≤–∏–¥–∏–º–æ–π –∏ –º–æ–ª–æ–¥–æ–π"

–ü–†–ò–ú–ï–† 2:
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
[1] –≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è –≤ –ø–∞—Ä–∏–∂–µ
[2] —Å—Ç—Ä–æ–∏–ª–∏ –≤ 19 –≤–µ–∫–µ
–í–æ–ø—Ä–æ—Å: "–∫–∞–∫–∞—è –µ—ë –≤—ã—Å–æ—Ç–∞"
‚Üí –ü–æ–Ω–∏–º–∞–µ—à—å: "–µ—ë" = –≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è
‚Üí –ò—â–µ—à—å: "–≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è –≤—ã—Å–æ—Ç–∞"
‚Üí –û—Ç–≤–µ—Ç: "—Ç—Ä–∏—Å—Ç–∞ –¥–≤–∞–¥—Ü–∞—Ç—å —á–µ—Ç—ã—Ä–µ –º–µ—Ç—Ä–∞"

–ü–†–ò–ú–ï–† 3:
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
[1] —Å–º–æ—Ç—Ä–µ–ª —Ñ–∏–ª—å–º –∏–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä
[2] —Ç–∞–º –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π –ª–µ—Ç–∞–ª –≤ –∫–æ—Å–º–æ—Å
–í–æ–ø—Ä–æ—Å: "–∫—Ç–æ –∏–≥—Ä–∞–ª –≥–ª–∞–≤–Ω—É—é —Ä–æ–ª—å"
‚Üí –ü–æ–Ω–∏–º–∞–µ—à—å: —Ä–µ—á—å –æ —Ñ–∏–ª—å–º–µ –ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä
‚Üí –ò—â–µ—à—å: "–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä –≥–ª–∞–≤–Ω–∞—è —Ä–æ–ª—å –∞–∫—Ç—ë—Ä"
‚Üí –û—Ç–≤–µ—Ç: "–º—ç—Ç—Ç—å—é –º–∞–∫–∫–æ–Ω–∞—Ö–∏"

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –í–°–ï–ì–î–ê –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º
- –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–π –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è - –∑–∞–º–µ–Ω—è–π –∏—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –í–°–ï–• —Å—Ç—Ä–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –∏—â–∏ –ø–æ –≤–æ–ø—Ä–æ—Å—É

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞!
"""

    try:
        response = client.models.generate_content(
            model='gemini-2.5-flash',
            contents=prompt,
            config={"tools": [{"google_search": {}}]}
        )
        answer = response.text.strip()

        print(f"–û–¢–í–ï–¢ –ò–ò: {answer}\n")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
        telegram_msg = f"üîç *–û—Ç–≤–µ—Ç:* {answer}\n\n"
        if context:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å—Ç—Ä–æ–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context_lines = context.split('\n')[-3:]
            telegram_msg += f"üìù _–ö–æ–Ω—Ç–µ–∫—Å—Ç:_\n{chr(10).join(context_lines)}"

        send_telegram(telegram_msg)

        return jsonify({"status": "success", "answer": answer})

    except Exception as e:
        error_msg = f"–û—à–∏–±–∫–∞ Gemini API: {str(e)}"
        print(error_msg)
        send_telegram(f"‚ùå *–û—à–∏–±–∫–∞:* {str(e)}")
        return jsonify({"status": "error", "message": error_msg}), 500


if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    print(f"\nüöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    print(f"üì° Gemini API: {'‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω' if GEMINI_API_KEY else '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    print(f"üí¨ Telegram Bot: {'‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' if TELEGRAM_BOT_TOKEN else '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}\n")
    app.run(host='0.0.0.0', port=port, debug=True)